<body>
  <!DOCTYPE html>
<html lang="en-us">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="" name="keywords">
<meta content="第三方 Android ROM 无法连接 Google Play 的原因排查 - 宇宙よりも遠い場所" property="og:title">
<title>第三方 Android ROM 无法连接 Google Play 的原因排查 | 宇宙よりも遠い場所</title>
<script src="https://unpkg.com/muse-player/dist/assets/muse-player.js"></script>
<link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet">
<link rel="stylesheet" href="https://kirainmoe.com//css/style.css">
<link rel="stylesheet" href="https://kirainmoe.com//css/custom.css">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" integrity="sha384-9tPv11A+glH/on/wEu99NVwDPwkMQESOocs/ZGXPoIiLE8MU/qkqUcZ3zzL+6DuH" crossorigin="anonymous">
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

<style type="text/css">
	.nav-left {	display: block; text-align: left; }
	.nav-link { display: inline-block; margin: 0px 20px 0px 0px;  }
	.nav-item { justify-content: flex-start;  }
	.nav-title { margin: 0px; font-size: 28px; font-weight: bold;  }
	.nav-title a { padding: 10px 0px;  }
	@media screen and (max-width: 700px) {
		.nav { display: block; text-align: center;  }
		.nav-title > .nav-item { display: block;  text-align: center; }
		.nav-left { text-align: center;  }
	}
</style>
  <section class="section navigator">
  <div class="navigator-background"></div>
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <h1 class="nav-title"><a class="nav-item" href="https://kirainmoe.com/">宇宙よりも遠い場所</a></h1>
        <div class="nav-links">
          <a class="nav-link" href="/pages/guestbook/">Guestbook</a>
          <a class="nav-link" href="/pages/friends/">Friends</a>        
          <a class="nav-link" href="https://about.me/kirainmoe">About</a>
        </div>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/kirainmoe">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/yume_kankawa">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://weibo.com/returnnnn">
            <span class="icon">
              <i class="fa fa-weibo"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://acm.kirainmoe.com">
            <span class="icon">
              <i class="fa fa-tumblr"></i>
            </span>
          </a>
          
          <a class="level-item" href="/index.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<div class="return-top">
  <i class="fa fa-angle-up"></i>
</div>

<div class="loading-progress"></div>
  <section class="section content-container">
    <div class="container article-here">
      <h2 class="subtitle is-6">March 4, 2018</h2>
      <h1 class="title">第三方 Android ROM 无法连接 Google Play 的原因排查</h1>
      
      <div class="tags">
    
        <a class="button is-link" href="/tags/android">android</a>
    
        <a class="button is-link" href="/tags/play">play</a>
    
        <a class="button is-link" href="/tags/google">google</a>
    
</div>

      
      <div class="content">
        <p>现在用的手机已经服役快要四年了，这年头这种的手机大概也就真的只能拿来当手机用了，于是就刷了个第三方适配的 Flyme 好好用着。虽然平时不太从 Google Play 下载软件，必要时也可以用 APKPure 代替，但是聊聊 LINE 什么的没有 GCM 的推送十分不方便，有时候打开提示一条消息，结果已经是三小时前的了。于是想了想还是决定安装 Google 的那一套东西。然而，无论我用任何第三方工具安装，或者是下载 opengapps 的卡刷包刷入，Google Play 都无法工作。</p>

<p></p>

<p>具体表现为在第一次进入 Play 提示要登录账号的时候提示“无法连接 与 Google 服务器通信出现问题”，而且完全看不到登录账号的界面。在确信梯子没有问题之后，我尝试了：</p>

<ul>
<li>更换 WiFi/移动网络</li>
<li>使用魅族商店的谷歌安装器</li>
<li>清除 Google 服务框架的全部数据</li>
<li>开启定位服务并授予 Google 服务框架所有的权限</li>
<li>删除 /system/etc/hosts 文件</li>
<li>降级 Google 套件</li>
<li>重置手机</li>
</ul>

<p>都没有什么卵用。想到之前用 lineageOS 和 MIUI 的时候 Google 框架都正常工作，到网络上搜索相关问题找到的大部分也是 Flyme 用户问的，于是怀疑是不是 Flyme 偷偷做了什么不可描述的事情。但是，Flyme 用户提出的所有解决问题的办法对我来说都没有用。</p>

<p>在 StackOverflow 上，有玩家提到可以用 adb 排查原因，于是照做发现，确实可行。如果你也遇到相似的问题，可以尝试下面的步骤排查，然后解决。</p>

<p>首先到开发者选项中打开 USB 调试，连接电脑，在手机上操作授权调试。建议关闭后台的所有程序，然后在电脑端执行：<code>adb logcat</code> 命令。接着终端会闪过一堆的字，这是在打印 log. 等到终端打出来的字差不多稳定的时候，在手机上打开 Google Play，进入添加账号界面。此时电脑上会显示 Google 框架的 log，查找是否有以 <code>E Checkin failed</code> 类似的错误提示，例如在我这里是：</p>

<pre><code>CheckinTask: Checkin failed: https://android.clients.google.com/checkin (request #0): java.io.IOException: Rejected response from server: invalid hardware identifier: &quot;HM NOTE 1LTE&quot; is not a valid device.
</code></pre>

<p>从错误信息当中我们可以知道，设备没有通过 Google 的设备验证 (checkin)，原因是当前设备无效，而前面那个很明显是手机的型号。然而，考虑到之前用 lineageOS 的时候是可以用的，跟手机型号的关系应该不是很大。于是进一步查找原因，root 后查看 <code>/system/build.prop</code>, 发现上文的手机型号是 <code>ro.product.name</code> 和 <code>ro.product.device</code> 的值。</p>

<p>于是猜测问题应该出在这里了。找出之前用的 lineageOS 的包，对比两个 ROM 的 build.prop 文件，发现 <code>ro.product.name</code> 大家都是一样的，但是在 lineageOS 中，<code>ro.product.device</code> 是这台设备的代号 (dior) 而不是具体型号。尝试将当前系统的 <code>ro.product.device</code> 修改，重启之后，问题解决，Google Play 可以正常使用，GCM 也 OK 了。</p>

<p>再搜索相关资料，发现原来在登录 Google 账号之前，Google 框架会先和 Google 服务器通信，对当前设备进行验证，提交的信息包括设备型号和 IMEI 等等。提交的设备型号就是 <code>ro.product.device</code> 的值，但是 Google 要求提交的型号不允许带有空格和中文等值，于是就造成了上述验证不通过的问题。</p>

<p><s>所以这个锅 ROM 作者背定了。</s></p>
      </div>
    </div>
  </section>
  
<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'yume-diary';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


  <section class="section footblock">
  <img src="https://secure.gravatar.com/avatar/c47187d311099868de825697fa419654?s=200&r=G" width="70px" height="70px" class="avatar">
  <div class="container has-text-centered">
    <p>&copy;2018 YumeのDiary / Published with <a href="https://gohugo.io">Hugo</a> / <a href="https://themes.gohugo.io/hemingway2/">Theme</a></p>
  </div>
</section>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>


<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/dockerfile.min.js"></script>


<script>hljs.initHighlightingOnLoad();</script>
<script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script>
<script src="https://kirainmoe.com//index.js"></script>


<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-111347233-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



</body>
